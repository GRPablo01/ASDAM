<div class="h-140 2xl:h-163">
  <!-- Container principal : grille responsive -->
  <div class="-mb-70 h-163 grid grid-cols-1 md:grid-cols-3 gap-2 p-2 bg-[var(--Blanc)] dark:bg-[var(--Black)]/90 overflow-hidden">

    <!-- ===== COLONNE GAUCHE : Contacts ===== -->
    <aside class="md:col-span-1 flex flex-col gap-2" [class.hidden]="selectedContact && isMobileScreen">

      <!-- ===== Utilisateur connecté (clair/sombre) ===== -->
      <section class="mt-5 flex items-center gap-4 px-5 py-4 rounded-2xl shadow-md
              bg-[var(--Black)]/80 dark:bg-[var(--Gris)]/90 backdrop-blur-md transition-all duration-300" role="region"
        aria-label="Utilisateur connecté">
        <!-- Avatar / Initiales -->
        <div
          class="grid h-12 w-12 place-items-center rounded-full bg-gradient-to-br 
                from-[var(--Rouge-Clair)] to-[var(--Rouge-Foncé)] text-white font-semibold text-lg select-none shadow-sm"
          aria-hidden="true">
          {{ userInitiales }}
        </div>

        <!-- Nom utilisateur -->
        <div>
          <p class="text-lg font-black text-[var(--Black)] dark:text-[var(--Blanc)]">{{ userPrenom }} {{ userNom }}</p>
          <p class="text-md font-black text-[var(--Black)] dark:text-[var(--Blanc)]">Connecté</p>
        </div>
      </section>


      <!-- ====== Recherche directe ====== -->
      <section class="bg-white/90 dark:bg-[var(--Gris)] border border-red-700 rounded-xl p-3 pb-1 shadow-sm">
        <!-- Champ de recherche -->
        <div class="relative">
          <input type="text" placeholder="Rechercher un nom…" [(ngModel)]="searchText"
            (input)="onSearchChange(searchText)"
            class="w-full pl-10 pr-3 py-2 rounded-lg text-[var(--Black)] dark:text-[var(--Blanc)] bg-[var(--Blanc)] dark:bg-[var(--Gris)] text-sm focus:outline-none transition" />
          <i class="fas fa-search absolute left-3 top-2.5 text-[var(--Rouge)]"></i>
        </div>

        <!-- Suggestions -->
        <ul *ngIf="showSuggestions" class="mt-2 max-h-32 overflow-y-auto space-y-1">
          <li *ngFor="let c of getFilteredContacts()" (mousedown)="selectSuggestion(c)"
            class="flex items-center gap-2 p-2 hover:bg-gray-200/30  dark:hover:bg-gray-100/10 rounded-lg cursor-pointer text-sm transition">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white grid place-items-center font-semibold">
              {{ c.firstName[0] }}{{ c.lastName[0] }}
            </div>
            <span class="flex-1">
              <i class="fas fa-user mr-1 text-[var(--Black)] dark:text-[var(--Blanc)]"></i>
              <span class="text-[var(--Black)] dark:text-[var(--Blanc)]">{{ c.firstName }} {{ c.lastName }}</span>
            </span>
          </li>
        </ul>
      </section>


      <!-- Liste contacts -->
      <section
        class="mb-87 flex-1 flex flex-col bg-white/90 dark:bg-[var(--Gris)] border border-red-700 rounded-xl p-3 shadow-sm">
        <div class="flex items-center justify-between px-2 mb-2">
          <span class="text-sm font-semibold text-[var(--Black)] dark:text-[var(--Blanc)]"><i
              class="fas fa-address-book mr-1"></i>
            Contacts</span>
          <div class="flex gap-2">
            <button (click)="pageContacts = pageContacts - 1" [disabled]="pageContacts < 1"
              class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40 text-sm transition"><i
                class="fas fa-chevron-left"></i></button>
            <button (click)="pageContacts = pageContacts + 1" [disabled]="(pageContacts+1)*5 >= contacts.length"
              class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-40 text-sm transition"><i
                class="fas fa-chevron-right"></i></button>
          </div>
        </div>

        <div class="flex-1 grid gap-2 content-start">
          <a *ngFor="let c of contacts | slice:pageContacts*5:(pageContacts+1)*5; trackBy: trackByContactId"
            (click)="selectContact(c)" [class.ring-2]="selectedContact?._id === c._id"
            [class.ring-[var(--Rouge)]]="selectedContact?._id === c._id"
            class="flex items-center justify-between p-3 rounded-lg hover:bg-gray-200/10 cursor-pointer transition text-sm group">
            <div class="flex items-center gap-3">
              <div
                class="w-9 h-9 rounded-full bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white grid place-items-center text-sm font-semibold">
                {{ c.firstName[0] }}{{ c.lastName[0] }}
              </div>
              <span class="font-medium text-base"><i
                  class="fas fa-user mr-1  text-[var(--Black)] dark:text-[var(--Blanc)]"></i>

                <span class="text-[var(--Black)] dark:text-[var(--Blanc)]">{{ c.firstName }}
                  {{ c.lastName }}</span></span>
            </div>
            <button (click)="deleteContact(c); $event.stopPropagation()" title="Supprimer"
              class="w-6 h-6 rounded border-1 border-[var(--Rouge)] bg-red-700 hover:bg-[var(--Rouge)]/10 cursor-pointer text-white hover:text-[var(--Blanc)] grid place-items-center text-sm transition">
              <i class="fas fa-trash"></i>
            </button>
          </a>
        </div>
      </section>
    </aside>

    <!-- ===== COLONNE DROITE : Chat ===== -->
    <main
      class="mt-5 mb-87 h-125 2xl:h-148 md:col-span-2 bg-white/90 dark:bg-[var(--Gris)] border border-red-700 rounded-xl shadow-sm flex flex-col overflow-hidden"
      [class.hidden]="!selectedContact && isMobileScreen">

      <!-- Bouton retour mobile -->
      <div *ngIf="selectedContact && isMobileScreen" class="p-3 border-b border-red-700">
        <button (click)="selectedContact = null"
          class="flex items-center gap-2 text-[var(--Black)] dark:text-[var(--Blanc)] font-medium">
          <i class="fas fa-arrow-left"></i> Retour
        </button>
      </div>

      <ng-container *ngIf="selectedContact; else placeholder">
        <!-- Header du chat -->
        <header class="shrink-0 flex items-center gap-4 p-4 border-b border-gray-200">
          <div
            class="w-12 h-12 rounded-full bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white grid place-items-center text-lg font-bold">
            {{ selectedContact.firstName[0] }}{{ selectedContact.lastName[0] }}
          </div>
          <div>
            <h2 class="font-semibold text-xl text-[var(--Blanc)] dark:texte-[var(--Black)]">{{ selectedContact.firstName
              }} {{ selectedContact.lastName }}</h2>
          </div>
        </header>

        <!-- Messages -->
        <section #scrollContainer
          class="grow flex flex-col gap-3 px-4 py-3 max-h-[90vh] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-400/40 scrollbar-track-transparent">
          <!-- Bouton pour charger plus de messages -->
          <button *ngIf="messages.length > 5" (click)="loadOlder()"
            class="text-sm font-medium text-[var(--Bleu)] hover:text-[var(--Rouge)] transition mx-auto underline">
            Voir plus de messages
          </button>

          <!-- Messages -->
          <article *ngFor="let msg of messages; trackBy: trackByMsgId" class="flex items-end gap-3 text-sm"
            [class.flex-row-reverse]="msg.senderId === userId">
            <div
              class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--Bleu)] to-[var(--Bleu-Foncé)] text-white grid place-items-center font-semibold shadow-md">
              {{ msg.senderId === userId ? userInitiales : getInitiales(msg.senderName) }}
            </div>
            <div class="max-w-[70%]">
              <div [ngClass]="msg.senderId === userId
            ? 'bg-gradient-to-br from-[var(--Rouge)] to-[var(--Rouge-Foncé)] text-white'
            : 'bg-gray-100 text-[var(--Black)]'"
                class="px-3 py-2 rounded-xl shadow-md break-words transition hover:scale-[1.02]">
                {{ msg.text }}
              </div>
            </div>
          </article>
        </section>

        <!-- Input -->
          <footer class="shrink-0 border-t border-red-700 p-3 bg-white/90 dark:bg-[var(--Gris)]">
            <form (ngSubmit)="sendMessage()" class="flex items-center gap-3">
              <input type="text" [(ngModel)]="newMessage" name="newMessage" required placeholder="Écrivez votre message…"
                class="flex-1 px-4 py-3 rounded-full bg-[var(--Black)]/30  text-[var(--Blanc)] dark:text-[var(Blanc)] text-md focus:outline-none focus:ring-2 focus:ring-[var(--Rouge)]/50 transition" />
              <button type="submit" [disabled]="!newMessage?.trim() || isSending"
                class="flex items-center gap-1 px-4 py-2 rounded-full bg-[var(--Rouge)] hover:bg-[var(--Rouge-Foncé)] text-white font-medium shadow transition disabled:opacity-50">
                <i class="fas fa-paper-plane"></i><span>Envoyer</span>
              </button>
            </form>
          </footer>
      </ng-container>

      <!-- Placeholder -->
      <ng-template #placeholder>
        <div class="grid place-items-center h-full">
          <div class="text-center px-4">
            <i class="fas fa-comments text-3xl text-[var(--Rouge)] mb-2"></i>
            <h3 class="text-sm font-semibold text-[var(--Blanc)] dark:[var(--Black)]">Choisir un contact</h3>
            <p class="text-xs text-[var(--Blanc)] dark:[var(--Black)]">Les messages disparaissent après 48 h.</p>
          </div>
        </div>
      </ng-template>
    </main>

  </div>
</div>